<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>0xHiTek - AI Chat powered by OpenRouter</title>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom Styles - Embedded for security -->
    <style>
        /* ============================================
           0xHiTek Chat - Original Hacker Theme
           ============================================ */

        /* Root Variables - Black/Green Hacker Theme */
        :root {
            --primary: #00ff00;
            --primary-dark: #00cc00;
            --primary-glow: rgba(0, 255, 0, 0.5);
            --secondary: #00ffaa;
            --bg-dark: #000000;
            --bg-medium: #0a0a0a;
            --bg-light: #111111;
            --bg-card: rgba(0, 255, 0, 0.03);
            --text-primary: #00ff00;
            --text-light: #00ff00;
            --text-muted: rgba(0, 255, 0, 0.6);
            --text-white: #ffffff;
            --border: rgba(0, 255, 0, 0.2);
            --border-glow: rgba(0, 255, 0, 0.5);
            --success: #00ff00;
            --danger: #ff0040;
            --warning: #ffaa00;
            --info: #00aaff;
            --shadow: 0 0 20px rgba(0, 255, 0, 0.2);
            --glow: 0 0 10px rgba(0, 255, 0, 0.5);
        }

        /* Reset & Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* Matrix Background Effect */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 255, 0, 0.03) 2px,
                    rgba(0, 255, 0, 0.03) 4px
                );
            pointer-events: none;
            z-index: 1;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-content {
            text-align: center;
        }

        .logo-animation {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 2rem;
            text-shadow: var(--glow);
            animation: pulse 2s infinite;
        }

        .logo-0x {
            color: var(--primary);
        }

        .logo-hi {
            color: var(--text-white);
        }

        .logo-tek {
            color: var(--primary);
        }

        .loading-text {
            color: var(--text-primary);
            text-shadow: var(--glow);
            animation: blink 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

            /* Enhanced Model Selector */
        .model-select {
            padding: 0.5rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            cursor: pointer;
            max-width: 300px;
            font-size: 0.9rem;
        }
    
        .model-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--glow);
        }
    
        .model-select optgroup {
            background: var(--bg-medium);
            color: var(--primary);
            font-weight: bold;
        }
    
        .model-select option {
            background: var(--bg-dark);
            color: var(--text-primary);
            padding: 0.25rem;
        }
    
        .model-select option:hover {
            background: var(--bg-card);
        }
    
        /* Make it responsive */
        @media (max-width: 768px) {
            .model-select {
                max-width: 200px;
                font-size: 0.8rem;
            }
        }

        /* App Container */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: relative;
            z-index: 2;
        }

        /* Header */
        .header {
            background: var(--bg-medium);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: var(--glow);
        }

        .tagline {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-primary);
        }

        .header-buttons {
            display: flex;
            gap: 0.5rem;
        }

        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--primary);
            border-radius: 0;
            background: transparent;
            color: var(--primary);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            background: var(--primary);
            color: var(--bg-dark);
            box-shadow: var(--glow);
            transform: translateY(-2px);
        }

        .btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 0, 0.4), transparent);
            transition: left 0.5s;
        }

        .btn:hover:before {
            left: 100%;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--bg-dark);
            border-color: var(--primary);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-medium);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 1rem;
        }

        .new-chat-btn {
            width: 100%;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .chat-history {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .history-header {
            font-size: 0.9rem;
            color: var(--text-muted);
            padding: 0.5rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
        }

        .chat-item {
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0.5rem;
            border: 1px solid transparent;
            border-left: 3px solid transparent;
        }

        .chat-item:hover {
            background: var(--bg-card);
            border-color: var(--border);
        }

        .chat-item.active {
            background: var(--bg-card);
            border-left-color: var(--primary);
            box-shadow: inset 0 0 10px rgba(0, 255, 0, 0.1);
        }

        .chat-item-title {
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .chat-item-date {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-dark);
        }

        .chat-header {
            padding: 1rem;
            background: var(--bg-medium);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .model-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .model-select {
            padding: 0.5rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            cursor: pointer;
        }

        .model-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--glow);
        }

        .chat-info {
            display: flex;
            gap: 1rem;
        }

        .token-counter {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        /* Messages Container */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: var(--bg-dark);
        }

        .welcome-message {
            text-align: center;
            padding: 3rem 1rem;
        }

        .welcome-icon {
            font-size: 4rem;
            color: var(--primary);
            margin-bottom: 1rem;
            text-shadow: var(--glow);
        }

        .welcome-message h2 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: var(--primary);
            text-shadow: var(--glow);
        }

        .welcome-message p {
            color: var(--text-muted);
            margin-bottom: 2rem;
        }

        .features {
            display: flex;
            justify-content: center;
            gap: 2rem;
        }

        .feature {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .feature i {
            font-size: 2rem;
            color: var(--primary);
            text-shadow: var(--glow);
        }

        /* Messages */
        .message {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            animation: fadeIn 0.3s ease;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border: 1px solid var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
            color: var(--primary);
            background: var(--bg-medium);
        }

        .message-content {
            max-width: 70%;
            padding: 1rem;
            border: 1px solid var(--border);
            background: var(--bg-medium);
            color: var(--text-primary);
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: var(--bg-card);
            border-color: var(--primary);
        }

        .message-timestamp {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Input Area */
        .input-area {
            padding: 1rem;
            background: var(--bg-medium);
            border-top: 1px solid var(--border);
        }

        .input-container {
            display: flex;
            gap: 1rem;
        }

        .message-input {
            flex: 1;
            padding: 0.75rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            resize: none;
            min-height: 50px;
            max-height: 150px;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--glow);
        }

        .send-btn {
            padding: 0 1.5rem;
        }

        .input-info {
            margin-top: 0.5rem;
            min-height: 20px;
        }

        .typing-indicator {
            color: var(--text-muted);
            font-size: 0.9rem;
            animation: blink 1s infinite;
        }

        /* Admin Dashboard */
        .admin-dashboard {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            background: var(--bg-dark);
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .admin-header h2 {
            font-size: 1.5rem;
            color: var(--primary);
            text-shadow: var(--glow);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-medium);
            border: 1px solid var(--border);
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: var(--primary);
            box-shadow: var(--glow);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border: 1px solid var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--primary);
        }

        .stat-content h3 {
            font-size: 2rem;
            color: var(--primary);
            text-shadow: var(--glow);
        }

        .stat-content p {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .admin-section {
            background: var(--bg-medium);
            border: 1px solid var(--border);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .admin-section h3 {
            margin-bottom: 1rem;
            color: var(--primary);
            text-shadow: var(--glow);
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid var(--border);
        }

        .admin-table th,
        .admin-table td {
            padding: 0.75rem;
            text-align: left;
            border: 1px solid var(--border);
        }

        .admin-table th {
            background: var(--bg-medium);
            color: var(--primary);
        }

        .admin-table tr:hover {
            background: var(--bg-card);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-medium);
            border: 1px solid var(--primary);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.5);
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: transparent;
            border: none;
            color: var(--primary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-close:hover {
            color: var(--danger);
        }

        .modal-header {
            padding: 2rem 2rem 1rem;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h2 {
            margin-bottom: 0.5rem;
            color: var(--primary);
            text-shadow: var(--glow);
        }

        .modal-header p {
            color: var(--text-muted);
        }

        /* Forms */
        .auth-form,
        .profile-form {
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--glow);
        }

        .form-group small {
            display: block;
            margin-top: 0.25rem;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .form-group small a {
            color: var(--primary);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 2000;
        }

        .toast {
            background: var(--bg-medium);
            border: 1px solid var(--primary);
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: var(--glow);
            animation: slideInRight 0.3s ease;
            color: var(--text-primary);
        }

        .toast.success {
            border-color: var(--success);
        }

        .toast.error {
            border-color: var(--danger);
            color: var(--danger);
        }

        .toast.warning {
            border-color: var(--warning);
            color: var(--warning);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            to {
                transform: translateX(120%);
                opacity: 0;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border: 1px solid var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* Processing State */
        .processing-text {
            color: var(--text-primary);
            text-align: center;
            padding: 2rem;
            font-size: 1.2rem;
            text-shadow: var(--glow);
            animation: pulse 1s infinite;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .header {
                padding: 1rem;
            }
            
            .logo {
                font-size: 1.2rem;
            }
            
            .tagline {
                display: none;
            }
            
            .message-content {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="logo-animation">
                <span class="logo-0x">0x</span>
                <span class="logo-hi">Hi</span>
                <span class="logo-tek">Tek</span>
            </div>
            <p class="loading-text">INITIALIZING SYSTEM...</p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app" class="app-container" style="display: none;">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="logo">
                    <span class="logo-0x">0x</span>
                    <span class="logo-hi">Hi</span>
                    <span class="logo-tek">Tek</span>
                </div>
                <span class="tagline">AI Chat powered by OpenRouter</span>
            </div>
            
            <div class="header-right">
                <span id="userInfo" class="user-info" style="display: none;">
                    <i class="fas fa-user-circle"></i>
                    <span id="userEmail"></span>
                </span>
                
                <div class="header-buttons">
                    <button id="loginBtn" class="btn">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                    <button id="signupBtn" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i> Sign Up
                    </button>
                    <button id="profileBtn" class="btn" style="display: none;">
                        <i class="fas fa-cog"></i> Profile
                    </button>
                    <button id="adminBtn" class="btn" style="display: none;">
                        <i class="fas fa-shield-alt"></i> Admin
                    </button>
                    <button id="logoutBtn" class="btn" style="display: none;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Sidebar -->
            <aside class="sidebar" id="sidebar">
                <button id="newChatBtn" class="btn btn-primary new-chat-btn">
                    <i class="fas fa-plus"></i> New Chat
                </button>
                
                <div class="chat-history">
                    <div class="history-header">Chat History</div>
                    <div id="historyList" class="history-list">
                        <!-- Chat history items will be populated here -->
                    </div>
                </div>
            </aside>

            <!-- Chat Area -->
            <main class="chat-area" id="chatArea">
                <!-- Chat Header with Complete Model List -->
                <div class="chat-header">
                    <div class="model-selector">
                        <label for="modelSelect">
                            <i class="fas fa-robot"></i> Model:
                        </label>
                        <select id="modelSelect" class="model-select">
                            <!-- OpenAI Models -->
                            <optgroup label="OpenAI">
                                <option value="openai/gpt-4-turbo-preview">GPT-4 Turbo Preview (128k)</option>
                                <option value="openai/gpt-4-turbo">GPT-4 Turbo</option>
                                <option value="openai/gpt-4">GPT-4</option>
                                <option value="openai/gpt-4-32k">GPT-4 32k</option>
                                <option value="openai/gpt-3.5-turbo" selected>GPT-3.5 Turbo</option>
                                <option value="openai/gpt-3.5-turbo-16k">GPT-3.5 Turbo 16k</option>
                                <option value="openai/gpt-3.5-turbo-1106">GPT-3.5 Turbo 1106</option>
                                <option value="openai/gpt-3.5-turbo-0125">GPT-3.5 Turbo 0125</option>
                            </optgroup>
                
                            <!-- Anthropic Claude Models -->
                            <optgroup label="Anthropic">
                                <option value="anthropic/claude-3-opus">Claude 3 Opus</option>
                                <option value="anthropic/claude-3-sonnet">Claude 3 Sonnet</option>
                                <option value="anthropic/claude-3-haiku">Claude 3 Haiku</option>
                                <option value="anthropic/claude-2.1">Claude 2.1</option>
                                <option value="anthropic/claude-2">Claude 2</option>
                                <option value="anthropic/claude-instant-v1">Claude Instant v1</option>
                                <option value="anthropic/claude-instant-1.2">Claude Instant 1.2</option>
                            </optgroup>
                
                            <!-- Google Models -->
                            <optgroup label="Google">
                                <option value="google/gemini-pro">Gemini Pro</option>
                                <option value="google/gemini-pro-vision">Gemini Pro Vision</option>
                                <option value="google/gemini-pro-1.5">Gemini Pro 1.5</option>
                                <option value="google/palm-2-chat-bison">PaLM 2 Chat Bison</option>
                                <option value="google/palm-2-codechat-bison">PaLM 2 Code Chat</option>
                                <option value="google/palm-2-chat-bison-32k">PaLM 2 Chat Bison 32k</option>
                            </optgroup>
                
                            <!-- Meta Llama Models -->
                            <optgroup label="Meta Llama">
                                <option value="meta-llama/llama-2-70b-chat">Llama 2 70B Chat</option>
                                <option value="meta-llama/llama-2-13b-chat">Llama 2 13B Chat</option>
                                <option value="meta-llama/llama-2-7b-chat">Llama 2 7B Chat</option>
                                <option value="meta-llama/codellama-34b-instruct">CodeLlama 34B Instruct</option>
                                <option value="meta-llama/codellama-70b-instruct">CodeLlama 70B Instruct</option>
                                <option value="meta-llama/llama-3-8b-instruct">Llama 3 8B Instruct</option>
                                <option value="meta-llama/llama-3-70b-instruct">Llama 3 70B Instruct</option>
                            </optgroup>
                
                            <!-- Mistral AI Models -->
                            <optgroup label="Mistral AI">
                                <option value="mistralai/mistral-7b-instruct">Mistral 7B Instruct</option>
                                <option value="mistralai/mixtral-8x7b-instruct">Mixtral 8x7B Instruct</option>
                                <option value="mistralai/mixtral-8x22b-instruct">Mixtral 8x22B Instruct</option>
                                <option value="mistralai/mistral-tiny">Mistral Tiny</option>
                                <option value="mistralai/mistral-small">Mistral Small</option>
                                <option value="mistralai/mistral-medium">Mistral Medium</option>
                                <option value="mistralai/mistral-large">Mistral Large</option>
                            </optgroup>
                
                            <!-- Perplexity Models -->
                            <optgroup label="Perplexity">
                                <option value="perplexity/pplx-7b-chat">Perplexity 7B Chat</option>
                                <option value="perplexity/pplx-70b-chat">Perplexity 70B Chat</option>
                                <option value="perplexity/pplx-7b-online">Perplexity 7B Online</option>
                                <option value="perplexity/pplx-70b-online">Perplexity 70B Online</option>
                                <option value="perplexity/sonar-small-chat">Sonar Small Chat</option>
                                <option value="perplexity/sonar-medium-chat">Sonar Medium Chat</option>
                                <option value="perplexity/sonar-small-online">Sonar Small Online</option>
                                <option value="perplexity/sonar-medium-online">Sonar Medium Online</option>
                            </optgroup>
                
                            <!-- Cohere Models -->
                            <optgroup label="Cohere">
                                <option value="cohere/command">Command</option>
                                <option value="cohere/command-light">Command Light</option>
                                <option value="cohere/command-r">Command R</option>
                                <option value="cohere/command-r-plus">Command R Plus</option>
                            </optgroup>
                
                            <!-- Together AI Models -->
                            <optgroup label="Together AI">
                                <option value="togethercomputer/llama-2-7b-chat">Together Llama 2 7B</option>
                                <option value="togethercomputer/llama-2-13b-chat">Together Llama 2 13B</option>
                                <option value="togethercomputer/llama-2-70b-chat">Together Llama 2 70B</option>
                                <option value="togethercomputer/alpaca-7b">Alpaca 7B</option>
                                <option value="togethercomputer/falcon-7b-instruct">Falcon 7B Instruct</option>
                                <option value="togethercomputer/falcon-40b-instruct">Falcon 40B Instruct</option>
                            </optgroup>
                
                            <!-- NousResearch Models -->
                            <optgroup label="NousResearch">
                                <option value="nousresearch/nous-hermes-2-mixtral-8x7b-dpo">Nous Hermes 2 Mixtral 8x7B</option>
                                <option value="nousresearch/nous-hermes-2-mistral-7b-dpo">Nous Hermes 2 Mistral 7B</option>
                                <option value="nousresearch/nous-hermes-llama2-13b">Nous Hermes Llama2 13B</option>
                                <option value="nousresearch/nous-capybara-7b">Nous Capybara 7B</option>
                                <option value="nousresearch/nous-capybara-34b">Nous Capybara 34B</option>
                            </optgroup>
                
                            <!-- OpenChat Models -->
                            <optgroup label="OpenChat">
                                <option value="openchat/openchat-7b">OpenChat 7B</option>
                                <option value="openchat/openchat-3.5">OpenChat 3.5</option>
                                <option value="openchat/openchat-3.5-1210">OpenChat 3.5 1210</option>
                            </optgroup>
                
                            <!-- Phind Models -->
                            <optgroup label="Phind">
                                <option value="phind/phind-codellama-34b">Phind CodeLlama 34B</option>
                                <option value="phind/phind-codellama-34b-v2">Phind CodeLlama 34B v2</option>
                            </optgroup>
                
                            <!-- WizardLM Models -->
                            <optgroup label="WizardLM">
                                <option value="wizardlm/wizardlm-7b">WizardLM 7B</option>
                                <option value="wizardlm/wizardlm-13b">WizardLM 13B</option>
                                <option value="wizardlm/wizardlm-70b">WizardLM 70B</option>
                                <option value="wizardlm/wizardcoder-15b">WizardCoder 15B</option>
                                <option value="wizardlm/wizardcoder-34b">WizardCoder 34B</option>
                            </optgroup>
                
                            <!-- Teknium Models -->
                            <optgroup label="Teknium">
                                <option value="teknium/openhermes-2-mistral-7b">OpenHermes 2 Mistral 7B</option>
                                <option value="teknium/openhermes-2.5-mistral-7b">OpenHermes 2.5 Mistral 7B</option>
                            </optgroup>
                
                            <!-- Undi95 Models -->
                            <optgroup label="Undi95">
                                <option value="undi95/toppy-m-7b">Toppy M 7B</option>
                                <option value="undi95/remm-slerp-l2-13b">ReMM SLERP L2 13B</option>
                            </optgroup>
                
                            <!-- Gryphe Models -->
                            <optgroup label="Gryphe">
                                <option value="gryphe/mythomax-l2-13b">MythoMax L2 13B</option>
                                <option value="gryphe/mythomist-7b">MythoMist 7B</option>
                            </optgroup>
                
                            <!-- DeepSeek Models -->
                            <optgroup label="DeepSeek">
                                <option value="deepseek/deepseek-chat">DeepSeek Chat</option>
                                <option value="deepseek/deepseek-coder">DeepSeek Coder</option>
                            </optgroup>
                
                            <!-- Qwen Models -->
                            <optgroup label="Qwen">
                                <option value="qwen/qwen-7b-chat">Qwen 7B Chat</option>
                                <option value="qwen/qwen-14b-chat">Qwen 14B Chat</option>
                                <option value="qwen/qwen-72b-chat">Qwen 72B Chat</option>
                                <option value="qwen/qwen-1.5-7b-chat">Qwen 1.5 7B Chat</option>
                                <option value="qwen/qwen-1.5-14b-chat">Qwen 1.5 14B Chat</option>
                                <option value="qwen/qwen-1.5-72b-chat">Qwen 1.5 72B Chat</option>
                            </optgroup>
                
                            <!-- Yi Models -->
                            <optgroup label="Yi">
                                <option value="01-ai/yi-6b-chat">Yi 6B Chat</option>
                                <option value="01-ai/yi-34b-chat">Yi 34B Chat</option>
                            </optgroup>
                
                            <!-- Pygmalion Models -->
                            <optgroup label="Pygmalion">
                                <option value="pygmalionai/mythalion-13b">Mythalion 13B</option>
                            </optgroup>
                
                            <!-- Kobold Models -->
                            <optgroup label="Kobold">
                                <option value="koboldai/psyfighter-13b">Psyfighter 13B</option>
                                <option value="koboldai/psyfighter-13b-2">Psyfighter 13B 2</option>
                            </optgroup>
                
                            <!-- Intel Models -->
                            <optgroup label="Intel">
                                <option value="intel/neural-chat-7b">Neural Chat 7B</option>
                            </optgroup>
                
                            <!-- Hugging Face Models -->
                            <optgroup label="HuggingFace">
                                <option value="huggingfaceh4/zephyr-7b-beta">Zephyr 7B Beta</option>
                                <option value="huggingfaceh4/zephyr-7b-alpha">Zephyr 7B Alpha</option>
                            </optgroup>
                
                            <!-- Other/Specialized Models -->
                            <optgroup label="Specialized">
                                <option value="jondurbin/airoboros-l2-70b">Airoboros L2 70B</option>
                                <option value="jondurbin/bagel-34b">Bagel 34B</option>
                                <option value="austism/chronos-hermes-13b">Chronos Hermes 13B</option>
                                <option value="lizpreciatior/lzlv-70b-fp16-hf">LZLV 70B</option>
                                <option value="cognitivecomputations/dolphin-mixtral-8x7b">Dolphin Mixtral 8x7B</option>
                                <option value="recursal/rwkv-5-3b-ai-town">RWKV 5 3B AI Town</option>
                                <option value="recursal/eagle-7b">Eagle 7B</option>
                            </optgroup>
                
                            <!-- Free/Open Models -->
                            <optgroup label="Free Models">
                                <option value="gryphe/mythomist-7b:free">MythoMist 7B (Free)</option>
                                <option value="undi95/toppy-m-7b:free">Toppy M 7B (Free)</option>
                                <option value="openchat/openchat-7b:free">OpenChat 7B (Free)</option>
                                <option value="nousresearch/nous-capybara-7b:free">Nous Capybara 7B (Free)</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <div class="chat-info">
                        <div class="token-counter">
                            <i class="fas fa-coins"></i>
                            <span id="tokenCount">0</span> tokens
                        </div>
                    </div>
                </div>

                <!-- Messages Container -->
                <div class="messages-container" id="messagesContainer">
                    <div class="welcome-message">
                        <div class="welcome-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <h2>Welcome to 0xHiTek</h2>
                        <p>Your gateway to AI models via OpenRouter</p>
                        <div class="features">
                            <div class="feature">
                                <i class="fas fa-brain"></i>
                                <span>Multiple AI Models</span>
                            </div>
                            <div class="feature">
                                <i class="fas fa-cloud"></i>
                                <span>Cloud Storage</span>
                            </div>
                            <div class="feature">
                                <i class="fas fa-bolt"></i>
                                <span>Fast Response</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Processing Message (Hidden by default) -->
                <div id="processingMsg" class="processing-text" style="display: none;">
                    PROCESSING...
                </div>

                <!-- Input Area -->
                <div class="input-area">
                    <div class="input-container">
                        <textarea 
                            id="messageInput" 
                            class="message-input" 
                            placeholder="Type your message here..."
                            rows="1"
                        ></textarea>
                        <button id="sendBtn" class="send-btn btn btn-primary" disabled>
                            <i class="fas fa-paper-plane"></i> SEND
                        </button>
                    </div>
                    <div class="input-info">
                        <span id="typingIndicator" class="typing-indicator" style="display: none;">
                            <i class="fas fa-keyboard"></i> AI is typing...
                        </span>
                    </div>
                </div>
            </main>

            <!-- Admin Dashboard (Hidden by default) -->
            <div id="adminDashboard" class="admin-dashboard" style="display: none;">
                <div class="admin-header">
                    <h2><i class="fas fa-tachometer-alt"></i> ADMIN DASHBOARD</h2>
                    <button id="closeAdminBtn" class="btn">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalUsers">0</h3>
                            <p>Total Users</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalMessages">0</h3>
                            <p>Total Messages</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="activeToday">0</h3>
                            <p>Active Today</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalChats">0</h3>
                            <p>Total Chats</p>
                        </div>
                    </div>
                </div>
                
                <div class="admin-section">
                    <h3><i class="fas fa-users-cog"></i> USER MANAGEMENT</h3>
                    <div class="table-container">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Messages</th>
                                    <th>Joined</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Users will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" id="closeAuthModal">
                <i class="fas fa-times"></i>
            </button>
            
            <div class="modal-header">
                <h2 id="authTitle">LOGIN</h2>
                <p id="authSubtitle">Access the system</p>
            </div>
            
            <form id="authForm" class="auth-form">
                <div class="form-group">
                    <label for="authEmail">
                        <i class="fas fa-envelope"></i> Email
                    </label>
                    <input 
                        type="email" 
                        id="authEmail" 
                        placeholder="user@example.com"
                        required
                    >
                </div>
                
                <div class="form-group">
                    <label for="authPassword">
                        <i class="fas fa-lock"></i> Password
                    </label>
                    <input 
                        type="password" 
                        id="authPassword" 
                        placeholder="••••••••"
                        required
                    >
                </div>
                
                <div class="form-group" id="nameGroup" style="display: none;">
                    <label for="authName">
                        <i class="fas fa-user"></i> Full Name
                    </label>
                    <input 
                        type="text" 
                        id="authName" 
                        placeholder="John Doe"
                    >
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                    <span id="authSubmitText">LOGIN</span>
                </button>
                
                <div style="margin-top: 1rem; text-align: center;">
                    <p id="authToggleText" style="color: var(--text-muted);">
                        Don't have an account? 
                        <a href="#" id="authToggleLink" style="color: var(--primary);">Sign up</a>
                    </p>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile Settings Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" id="closeProfileModal">
                <i class="fas fa-times"></i>
            </button>
            
            <div class="modal-header">
                <h2>PROFILE SETTINGS</h2>
                <p>Configure your account</p>
            </div>
            
            <form id="profileForm" class="profile-form">
                <div class="form-group">
                    <label for="profileName">
                        <i class="fas fa-user"></i> Full Name
                    </label>
                    <input type="text" id="profileName" placeholder="Enter your full name">
                </div>
                
                <div class="form-group">
                    <label for="profileEmail">
                        <i class="fas fa-envelope"></i> Email
                    </label>
                    <input type="email" id="profileEmail" disabled>
                </div>
                
                <div class="form-group">
                    <label for="openrouterKey">
                        <i class="fas fa-key"></i> OpenRouter API Key
                    </label>
                    <input 
                        type="password" 
                        id="openrouterKey" 
                        placeholder="sk-or-v1-..."
                    >
                    <small>Get your API key from <a href="https://openrouter.ai/keys" target="_blank">OpenRouter.ai</a></small>
                </div>
                
                <div class="form-group">
                    <label for="maxTokens">
                        <i class="fas fa-coins"></i> Max Tokens
                    </label>
                    <input type="number" id="maxTokens" value="1000" min="100" max="4000">
                </div>
                
                <div class="form-group">
                    <label for="temperature">
                        <i class="fas fa-thermometer-half"></i> Temperature
                    </label>
                    <input type="number" id="temperature" value="0.7" min="0" max="2" step="0.1">
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                    <i class="fas fa-save"></i> SAVE SETTINGS
                </button>
            </form>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Main Application Script -->
    <script>
        // ============================================
        // Environment Configuration (Secure)
        // ============================================
        const ENV = {
            SUPABASE_URL: '', // Will be set from Netlify environment
            SUPABASE_ANON_KEY: '', // Will be set from Netlify environment
            OPENROUTER_API_KEY: '', // Will be set from Netlify environment
            ADMIN_EMAIL: 'admin@0xhitek.com'
        };

        // ============================================
        // Initialize Supabase Client
        // ============================================
        let supabase = null;

        // ============================================
        // State Management
        // ============================================
        class AppState {
            constructor() {
                this.user = null;
                this.currentChatId = null;
                this.messages = [];
                this.chats = [];
                this.settings = {
                    openrouterKey: '',
                    maxTokens: 1000,
                    temperature: 0.7,
                    selectedModel: 'openai/gpt-3.5-turbo'
                };
                this.tokenCount = 0;
                this.isProcessing = false;
                this.keepAliveInterval = null;
                this.lastActivity = Date.now();
            }

            setUser(user) {
                this.user = user;
                this.updateUI();
            }

            updateUI() {
                const elements = {
                    loginBtn: document.getElementById('loginBtn'),
                    signupBtn: document.getElementById('signupBtn'),
                    logoutBtn: document.getElementById('logoutBtn'),
                    profileBtn: document.getElementById('profileBtn'),
                    adminBtn: document.getElementById('adminBtn'),
                    userInfo: document.getElementById('userInfo'),
                    userEmail: document.getElementById('userEmail'),
                    sendBtn: document.getElementById('sendBtn')
                };

                if (this.user) {
                    elements.loginBtn.style.display = 'none';
                    elements.signupBtn.style.display = 'none';
                    elements.logoutBtn.style.display = 'block';
                    elements.profileBtn.style.display = 'block';
                    elements.userInfo.style.display = 'flex';
                    elements.userEmail.textContent = this.user.email;
                    elements.sendBtn.disabled = false;

                    if (this.user.email === ENV.ADMIN_EMAIL || this.user.role === 'admin') {
                        elements.adminBtn.style.display = 'block';
                    }
                } else {
                    elements.loginBtn.style.display = 'block';
                    elements.signupBtn.style.display = 'block';
                    elements.logoutBtn.style.display = 'none';
                    elements.profileBtn.style.display = 'none';
                    elements.adminBtn.style.display = 'none';
                    elements.userInfo.style.display = 'none';
                    elements.sendBtn.disabled = true;
                }
            }

            startKeepAlive() {
                if (this.keepAliveInterval) {
                    clearInterval(this.keepAliveInterval);
                }
                
                this.keepAliveInterval = setInterval(async () => {
                    if (this.user && !this.isProcessing && supabase) {
                        try {
                            await supabase.from('profiles').select('id').eq('id', this.user.id).limit(1).single();
                            this.lastActivity = Date.now();
                        } catch (error) {
                            console.log('Keep-alive ping');
                        }
                    }
                }, 20000); // 20 seconds
            }

            stopKeepAlive() {
                if (this.keepAliveInterval) {
                    clearInterval(this.keepAliveInterval);
                    this.keepAliveInterval = null;
                }
            }

            isConnectionStale() {
                return (Date.now() - this.lastActivity) > 30000;
            }

            updateActivity() {
                this.lastActivity = Date.now();
            }
        }

        const appState = new AppState();

        // ============================================
        // Initialization
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for environment variables to be injected
            setTimeout(async () => {
                // Try to initialize Supabase
                if (typeof window.supabase !== 'undefined' && ENV.SUPABASE_URL && ENV.SUPABASE_ANON_KEY) {
                    supabase = window.supabase.createClient(ENV.SUPABASE_URL, ENV.SUPABASE_ANON_KEY);
                    
                    // Check for existing session
                    const { data: { session } } = await supabase.auth.getSession();
                    if (session) {
                        appState.setUser(session.user);
                        await loadUserProfile();
                        await loadChatHistory();
                        appState.startKeepAlive();
                    }

                    // Setup auth state listener
                    supabase.auth.onAuthStateChange(async (event, session) => {
                        if (session) {
                            appState.setUser(session.user);
                            await loadUserProfile();
                            await loadChatHistory();
                            appState.startKeepAlive();
                        } else {
                            appState.setUser(null);
                            appState.stopKeepAlive();
                        }
                    });
                }

                // Hide loading screen
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('app').style.display = 'flex';

                if (!supabase) {
                    showToast('Please configure environment variables in Netlify', 'warning');
                }
            }, 1500);

            setupEventListeners();
        });

            function addModelSearch() {
                const modelSelect = document.getElementById('modelSelect');
                
                // Create search input
                const searchInput = document.createElement('input');
                searchInput.type = 'text';
                searchInput.placeholder = 'Search models...';
                searchInput.className = 'model-search';
                searchInput.style.cssText = `
                    padding: 0.5rem;
                    margin-bottom: 0.5rem;
                    background: var(--bg-dark);
                    border: 1px solid var(--border);
                    color: var(--text-primary);
                    font-family: 'Courier New', monospace;
                    width: 100%;
                `;
                
                // Insert search before select
                modelSelect.parentNode.insertBefore(searchInput, modelSelect);
                
                // Store all options
                const allOptions = Array.from(modelSelect.querySelectorAll('option'));
                const optgroups = Array.from(modelSelect.querySelectorAll('optgroup'));
                
                // Search function
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    
                    if (searchTerm === '') {
                        // Show all
                        optgroups.forEach(group => group.style.display = '');
                        allOptions.forEach(option => option.style.display = '');
                    } else {
                        // Filter options
                        optgroups.forEach(group => {
                            const visibleOptions = Array.from(group.querySelectorAll('option')).filter(option => {
                                const matches = option.text.toLowerCase().includes(searchTerm) || 
                                              option.value.toLowerCase().includes(searchTerm);
                                option.style.display = matches ? '' : 'none';
                                return matches;
                            });
                            
                            // Hide optgroup if no visible options
                            group.style.display = visibleOptions.length > 0 ? '' : 'none';
                        });
                    }
                });
            }
            
            // Call this after page loads
            document.addEventListener('DOMContentLoaded', () => {
                // addModelSearch(); // Uncomment to enable search
            });

        // ============================================
        // Event Listeners
        // ============================================
        function setupEventListeners() {
            // Auth buttons
            document.getElementById('loginBtn').addEventListener('click', () => openAuthModal('login'));
            document.getElementById('signupBtn').addEventListener('click', () => openAuthModal('signup'));
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Profile & Admin
            document.getElementById('profileBtn').addEventListener('click', openProfileModal);
            document.getElementById('adminBtn').addEventListener('click', openAdminDashboard);
            const closeAdminBtn = document.getElementById('closeAdminBtn');
            if (closeAdminBtn) {
                closeAdminBtn.addEventListener('click', closeAdminDashboard);
            }
            
            // Chat controls
            document.getElementById('newChatBtn').addEventListener('click', createNewChat);
            document.getElementById('sendBtn').addEventListener('click', () => sendMessage());
            
            // Message input
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            messageInput.addEventListener('input', () => {
                messageInput.style.height = 'auto';
                messageInput.style.height = messageInput.scrollHeight + 'px';
            });
            
            // Model selector
            document.getElementById('modelSelect').addEventListener('change', (e) => {
                appState.settings.selectedModel = e.target.value;
            });
            
            // Auth form
            document.getElementById('authForm').addEventListener('submit', handleAuthSubmit);
            document.getElementById('authToggleLink').addEventListener('click', toggleAuthMode);
            document.getElementById('closeAuthModal').addEventListener('click', closeAuthModal);
            
            // Profile form
            document.getElementById('profileForm').addEventListener('submit', handleProfileSubmit);
            document.getElementById('closeProfileModal').addEventListener('click', closeProfileModal);
        }

        // ============================================
        // Authentication Functions
        // ============================================

        // Add this function to dynamically load models from OpenRouter
        async function loadModelsFromAPI() {
            try {
                const response = await fetch('https://openrouter.ai/api/v1/models', {
                    headers: {
                        'Authorization': `Bearer ${appState.settings.openrouterKey}`,
                        'HTTP-Referer': window.location.origin,
                        'X-Title': '0xHiTek Chat'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const modelSelect = document.getElementById('modelSelect');
                    
                    // Group models by provider
                    const modelsByProvider = {};
                    
                    data.data.forEach(model => {
                        const provider = model.id.split('/')[0];
                        if (!modelsByProvider[provider]) {
                            modelsByProvider[provider] = [];
                        }
                        modelsByProvider[provider].push(model);
                    });
                    
                    // Clear and rebuild select
                    modelSelect.innerHTML = '';
                    
                    Object.keys(modelsByProvider).sort().forEach(provider => {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = provider.charAt(0).toUpperCase() + provider.slice(1);
                        
                        modelsByProvider[provider].forEach(model => {
                            const option = document.createElement('option');
                            option.value = model.id;
                            option.textContent = `${model.name} ($${model.pricing.prompt}/1K tokens)`;
                            optgroup.appendChild(option);
                        });
                        
                        modelSelect.appendChild(optgroup);
                    });
                    
                    // Restore selected model
                    modelSelect.value = appState.settings.selectedModel;
                }
            } catch (error) {
                console.error('Error loading models:', error);
            }
        }
        
        // Call this after user logs in
        // loadModelsFromAPI();
        
        async function handleAuthSubmit(e) {
            e.preventDefault();
            
            if (!supabase) {
                showToast('Database not configured', 'error');
                return;
            }
            
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const isLogin = document.getElementById('authTitle').textContent === 'LOGIN';
            
            try {
                if (isLogin) {
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email,
                        password
                    });
                    
                    if (error) throw error;
                    
                    showToast('Login successful!', 'success');
                    closeAuthModal();
                } else {
                    const fullName = document.getElementById('authName').value;
                    const { data, error } = await supabase.auth.signUp({
                        email,
                        password,
                        options: {
                            data: { full_name: fullName }
                        }
                    });
                    
                    if (error) throw error;
                    
                    showToast('Signup successful! Please check your email.', 'success');
                    closeAuthModal();
                }
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function handleLogout() {
            if (!supabase) return;
            
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                appState.user = null;
                appState.currentChatId = null;
                appState.messages = [];
                appState.stopKeepAlive();
                
                clearChatDisplay();
                showToast('Logged out successfully', 'success');
            } catch (error) {
                showToast('Error logging out', 'error');
            }
        }

        // ============================================
        // Profile Management
        // ============================================
        async function loadUserProfile() {
            if (!appState.user || !supabase) return;
            
            try {
                let { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', appState.user.id)
                    .single();
                
                if (error && error.code === 'PGRST116') {
                    // Profile doesn't exist, create it
                    const { data: newProfile, error: createError } = await supabase
                        .from('profiles')
                        .insert({
                            id: appState.user.id,
                            email: appState.user.email,
                            full_name: appState.user.user_metadata?.full_name || '',
                            openrouter_key: ENV.OPENROUTER_API_KEY || '',
                            role: appState.user.email === ENV.ADMIN_EMAIL ? 'admin' : 'user'
                        })
                        .select()
                        .single();
                    
                    if (!createError) {
                        data = newProfile;
                    }
                }
                
                if (data) {
                    if (data.openrouter_key) {
                        appState.settings.openrouterKey = data.openrouter_key;
                    }
                    if (data.settings) {
                        appState.settings = { ...appState.settings, ...data.settings };
                    }
                    
                    document.getElementById('profileName').value = data.full_name || '';
                    document.getElementById('profileEmail').value = data.email;
                    document.getElementById('openrouterKey').value = data.openrouter_key || '';
                    document.getElementById('maxTokens').value = appState.settings.maxTokens;
                    document.getElementById('temperature').value = appState.settings.temperature;
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        async function handleProfileSubmit(e) {
            e.preventDefault();
            
            if (!appState.user || !supabase) return;
            
            try {
                const profileData = {
                    full_name: document.getElementById('profileName').value,
                    openrouter_key: document.getElementById('openrouterKey').value,
                    settings: {
                        maxTokens: parseInt(document.getElementById('maxTokens').value),
                        temperature: parseFloat(document.getElementById('temperature').value),
                        selectedModel: document.getElementById('modelSelect').value
                    }
                };
                
                const { error } = await supabase
                    .from('profiles')
                    .update(profileData)
                    .eq('id', appState.user.id);
                
                if (error) throw error;
                
                appState.settings = { ...appState.settings, ...profileData.settings };
                appState.settings.openrouterKey = profileData.openrouter_key;
                
                showToast('Profile updated successfully', 'success');
                closeProfileModal();
            } catch (error) {
                showToast('Error updating profile', 'error');
            }
        }

        // ============================================
        // Chat Management
        // ============================================
        async function createNewChat() {
            if (!appState.user || !supabase) {
                showToast('Please login to create a chat', 'warning');
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('chats')
                    .insert({
                        user_id: appState.user.id,
                        title: 'New Chat'
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                
                appState.currentChatId = data.id;
                appState.messages = [];
                clearChatDisplay();
                await loadChatHistory();
            } catch (error) {
                showToast('Error creating chat', 'error');
            }
        }

        async function loadChat(chatId) {
            if (!appState.user || !supabase) return;
            
            try {
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('*')
                    .eq('chat_id', chatId)
                    .order('created_at', { ascending: true });
                
                if (error) throw error;
                
                appState.currentChatId = chatId;
                appState.messages = messages || [];
                displayMessages();
                updateChatHistoryUI();
            } catch (error) {
                showToast('Error loading chat', 'error');
            }
        }

        async function loadChatHistory() {
            if (!appState.user || !supabase) return;
            
            try {
                const { data, error } = await supabase
                    .from('chats')
                    .select('*')
                    .eq('user_id', appState.user.id)
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                if (error) throw error;
                
                appState.chats = data || [];
                displayChatHistory();
            } catch (error) {
                console.error('Error loading chat history:', error);
            }
        }

        function displayChatHistory() {
            const historyList = document.getElementById('historyList');
            
            if (appState.chats.length === 0) {
                historyList.innerHTML = '<div class="chat-item">No chats yet</div>';
                return;
            }
            
            historyList.innerHTML = appState.chats.map(chat => `
                <div class="chat-item ${chat.id === appState.currentChatId ? 'active' : ''}" 
                     onclick="loadChat('${chat.id}')"
                     data-chat-id="${chat.id}">
                    <div class="chat-item-title">${chat.title || 'New Chat'}</div>
                    <div class="chat-item-date">${formatDate(chat.created_at)}</div>
                </div>
            `).join('');
        }

        function updateChatHistoryUI() {
            document.querySelectorAll('.chat-item').forEach(item => {
                if (item.dataset.chatId === appState.currentChatId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // ============================================
        // Message Handling
        // ============================================
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || appState.isProcessing) return;
            
            if (!appState.user) {
                showToast('Please login to send messages', 'warning');
                return;
            }
            
            // Check connection
            if (appState.isConnectionStale()) {
                await refreshConnection();
            }
            
            appState.isProcessing = true;
            appState.updateActivity();
            
            // Show processing message
            document.getElementById('processingMsg').style.display = 'block';
            
            try {
                if (!appState.currentChatId) {
                    await createNewChat();
                }
                
                messageInput.value = '';
                messageInput.style.height = 'auto';
                
                displayMessage('user', message);
                
                // Save user message
                if (supabase) {
                    const { data: userMessage } = await supabase
                        .from('messages')
                        .insert({
                            chat_id: appState.currentChatId,
                            user_id: appState.user.id,
                            role: 'user',
                            content: message
                        })
                        .select()
                        .single();
                    
                    if (userMessage) {
                        appState.messages.push(userMessage);
                    }
                }
                
                showTypingIndicator();
                
                // Get AI response
                const aiResponse = await getAIResponse(message);
                
                hideTypingIndicator();
                document.getElementById('processingMsg').style.display = 'none';
                
                if (aiResponse) {
                    displayMessage('assistant', aiResponse);
                    
                    // Save AI response
                    if (supabase) {
                        const { data: assistantMessage } = await supabase
                            .from('messages')
                            .insert({
                                chat_id: appState.currentChatId,
                                user_id: appState.user.id,
                                role: 'assistant',
                                content: aiResponse
                            })
                            .select()
                            .single();
                        
                        if (assistantMessage) {
                            appState.messages.push(assistantMessage);
                        }
                    }
                    
                    // Update chat title if first message
                    if (appState.messages.length <= 2) {
                        await updateChatTitle(message);
                    }
                }
            } catch (error) {
                hideTypingIndicator();
                document.getElementById('processingMsg').style.display = 'none';
                showToast('Error: ' + error.message, 'error');
            } finally {
                appState.isProcessing = false;
            }
        }

        async function getAIResponse(message) {
            const apiKey = appState.settings.openrouterKey || ENV.OPENROUTER_API_KEY;
            
            if (!apiKey) {
                throw new Error('OpenRouter API key not configured. Please add it in your profile settings.');
            }
            
            const messages = [
                ...appState.messages.slice(-10).map(msg => ({
                    role: msg.role,
                    content: msg.content
                })),
                { role: 'user', content: message }
            ];
            
            // Check if on Netlify
            const isProduction = window.location.hostname.includes('netlify.app') || 
                               window.location.hostname.includes('0xhitek.com');
            
            const apiUrl = isProduction 
                ? '/.netlify/functions/openrouter-proxy'
                : 'https://openrouter.ai/api/v1/chat/completions';
            
            try {
                const requestBody = {
                    model: appState.settings.selectedModel,
                    messages: messages,
                    maxTokens: appState.settings.maxTokens,
                    temperature: appState.settings.temperature
                };
                
                if (isProduction) {
                    requestBody.apiKey = apiKey;
                }
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: isProduction 
                        ? { 'Content-Type': 'application/json' }
                        : {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json',
                            'HTTP-Referer': window.location.origin,
                            'X-Title': '0xHiTek Chat'
                        },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `API Error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.usage) {
                    appState.tokenCount += data.usage.total_tokens || 0;
                    updateTokenDisplay();
                }
                
                return data.choices[0]?.message?.content || 'No response generated';
            } catch (error) {
                console.error('OpenRouter API error:', error);
                throw error;
            }
        }

        async function refreshConnection() {
            if (!supabase) return;
            
            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                if (session) {
                    appState.user = session.user;
                    appState.updateActivity();
                }
            } catch (error) {
                console.error('Error refreshing connection:', error);
            }
        }

        async function updateChatTitle(message) {
            if (!appState.currentChatId || !supabase) return;
            
            try {
                const title = message.substring(0, 50) + (message.length > 50 ? '...' : '');
                
                await supabase
                    .from('chats')
                    .update({ title })
                    .eq('id', appState.currentChatId);
                
                await loadChatHistory();
            } catch (error) {
                console.error('Error updating chat title:', error);
            }
        }

        // ============================================
        // UI Functions
        // ============================================
        function displayMessage(role, content) {
            const container = document.getElementById('messagesContainer');
            
            const welcomeMsg = container.querySelector('.welcome-message');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            avatarDiv.innerHTML = role === 'user' ? 'U' : '<i class="fas fa-robot"></i>';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            container.appendChild(messageDiv);
            
            container.scrollTop = container.scrollHeight;
        }

        function displayMessages() {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';
            
            if (appState.messages.length === 0) {
                container.innerHTML = `
                    <div class="welcome-message">
                        <div class="welcome-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <h2>Welcome to 0xHiTek</h2>
                        <p>Your gateway to AI models via OpenRouter</p>
                    </div>
                `;
                return;
            }
            
            appState.messages.forEach(msg => {
                displayMessage(msg.role, msg.content);
            });
        }

        function clearChatDisplay() {
            displayMessages();
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'block';
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function updateTokenDisplay() {
            document.getElementById('tokenCount').textContent = appState.tokenCount.toLocaleString();
        }

        // ============================================
        // Admin Functions
        // ============================================
        async function openAdminDashboard() {
            if (!appState.user || !supabase) return;
            
            try {
                const { data: profile } = await supabase
                    .from('profiles')
                    .select('role')
                    .eq('id', appState.user.id)
                    .single();
                
                if (profile?.role !== 'admin' && appState.user.email !== ENV.ADMIN_EMAIL) {
                    showToast('Unauthorized access', 'error');
                    return;
                }
                
                // Load statistics
                const { data: users } = await supabase.from('profiles').select('*');
                const { data: messages } = await supabase.from('messages').select('id');
                const { data: chats } = await supabase.from('chats').select('id');
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const { data: activeUsers } = await supabase
                    .from('profiles')
                    .select('id')
                    .gte('updated_at', today.toISOString());
                
                // Update stats
                document.getElementById('totalUsers').textContent = users?.length || 0;
                document.getElementById('totalMessages').textContent = messages?.length || 0;
                document.getElementById('totalChats').textContent = chats?.length || 0;
                document.getElementById('activeToday').textContent = activeUsers?.length || 0;
                
                // Populate users table
                if (users) {
                    const tbody = document.getElementById('usersTableBody');
                    tbody.innerHTML = users.map(user => `
                        <tr>
                            <td>${user.full_name || 'N/A'}</td>
                            <td>${user.email}</td>
                            <td>${user.role || 'user'}</td>
                            <td>${user.message_count || 0}</td>
                            <td>${formatDate(user.created_at)}</td>
                            <td>
                                <button class="btn" onclick="toggleUserRole('${user.id}')">
                                    ${user.role === 'admin' ? 'Remove Admin' : 'Make Admin'}
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
                
                // Show dashboard
                document.getElementById('chatArea').style.display = 'none';
                document.getElementById('adminDashboard').style.display = 'block';
            } catch (error) {
                showToast('Error loading admin dashboard', 'error');
            }
        }

        function closeAdminDashboard() {
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('chatArea').style.display = 'flex';
        }

        async function toggleUserRole(userId) {
            if (!supabase) return;
            
            try {
                const { data: user } = await supabase
                    .from('profiles')
                    .select('role')
                    .eq('id', userId)
                    .single();
                
                const newRole = user?.role === 'admin' ? 'user' : 'admin';
                
                await supabase
                    .from('profiles')
                    .update({ role: newRole })
                    .eq('id', userId);
                
                showToast(`User role updated to ${newRole}`, 'success');
                await openAdminDashboard();
            } catch (error) {
                showToast('Error updating user role', 'error');
            }
        }

        // ============================================
        // Modal Functions
        // ============================================
        function openAuthModal(mode) {
            const modal = document.getElementById('authModal');
            const title = document.getElementById('authTitle');
            const subtitle = document.getElementById('authSubtitle');
            const submitText = document.getElementById('authSubmitText');
            const nameGroup = document.getElementById('nameGroup');
            const toggleText = document.getElementById('authToggleText');
            
            if (mode === 'login') {
                title.textContent = 'LOGIN';
                subtitle.textContent = 'Access the system';
                submitText.textContent = 'LOGIN';
                nameGroup.style.display = 'none';
                toggleText.innerHTML = "Don't have an account? <a href='#' id='authToggleLink' style='color: var(--primary);'>Sign up</a>";
            } else {
                title.textContent = 'SIGN UP';
                subtitle.textContent = 'Create your account';
                submitText.textContent = 'SIGN UP';
                nameGroup.style.display = 'block';
                toggleText.innerHTML = "Already have an account? <a href='#' id='authToggleLink' style='color: var(--primary);'>Login</a>";
            }
            
            modal.classList.add('active');
            document.getElementById('authToggleLink').addEventListener('click', toggleAuthMode);
        }

        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('active');
            document.getElementById('authForm').reset();
        }

        function toggleAuthMode(e) {
            e.preventDefault();
            const currentMode = document.getElementById('authTitle').textContent === 'LOGIN' ? 'signup' : 'login';
            openAuthModal(currentMode);
        }

        function openProfileModal() {
            document.getElementById('profileModal').classList.add('active');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('active');
        }

        // ============================================
        // Utility Functions
        // ============================================
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });
        }

        // Make functions available globally
        window.toggleUserRole = toggleUserRole;
        window.loadChat = loadChat;
    </script>

    <!-- Inject Environment Variables Script -->
    <script>
        // This will be replaced by your build process or edge function
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            // Local development - you can hardcode for testing
            // ENV.SUPABASE_URL = 'your_url_here';
            // ENV.SUPABASE_ANON_KEY = 'your_key_here';
            // ENV.OPENROUTER_API_KEY = 'your_key_here';
        }
    </script>
</body>
</html>
